-- Copy everything below this line and paste into Railway Query tab
-- ============================================================================

ALTER TABLE bots
ADD COLUMN IF NOT EXISTS last_heartbeat TIMESTAMP,
ADD COLUMN IF NOT EXISTS last_trade_time TIMESTAMP,
ADD COLUMN IF NOT EXISTS health_status VARCHAR(20) DEFAULT 'unknown',
ADD COLUMN IF NOT EXISTS reported_status VARCHAR(20),
ADD COLUMN IF NOT EXISTS status_updated_at TIMESTAMP DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS health_message TEXT;

ALTER TABLE bots
ADD COLUMN IF NOT EXISTS chain VARCHAR(20),
ADD COLUMN IF NOT EXISTS bot_type VARCHAR(20),
ADD COLUMN IF NOT EXISTS config JSONB DEFAULT '{}';

CREATE TABLE IF NOT EXISTS bot_health_logs (
    id SERIAL PRIMARY KEY,
    bot_id VARCHAR(255) REFERENCES bots(id) ON DELETE CASCADE,
    checked_at TIMESTAMP DEFAULT NOW(),
    previous_status VARCHAR(20),
    new_status VARCHAR(20),
    health_status VARCHAR(20),
    reason TEXT,
    trade_count_since_last INTEGER DEFAULT 0,
    last_trade_found TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_bot_health_logs_bot_id ON bot_health_logs(bot_id);
CREATE INDEX IF NOT EXISTS idx_bot_health_logs_checked_at ON bot_health_logs(checked_at);
CREATE INDEX IF NOT EXISTS idx_bots_health_status ON bots(health_status);

UPDATE bots SET reported_status = status WHERE reported_status IS NULL;

CREATE TABLE IF NOT EXISTS trading_keys (
    id SERIAL PRIMARY KEY,
    client_id VARCHAR(255) UNIQUE NOT NULL,
    encrypted_key TEXT NOT NULL,
    chain VARCHAR(20) DEFAULT 'solana',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_trading_keys_client_id ON trading_keys(client_id);
